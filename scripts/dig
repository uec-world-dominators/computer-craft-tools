local turtle = turtle
local vector = vector
local shell = shell

shell.run("navigation.lua")
shell.run("util.lua")
shell.run("handlers.lua")

local args = {...}



-- 3マス分の高さで直線に掘る
local function line(n, nav)
    nav:move(UP)
    nav:dig(UP)
    for i = 1, n - 1 do 
        nav:dig(FORWARD)
        nav:move(FORWARD)
        nav:dig(UP)
        nav:dig(DOWN)
    end
    nav:move(DOWN)
end

-- 高さ;3マス x 奥行きm x 幅nで掘りぬく
local function plane(m, n, nav)
    for i = 1, n do
        line(m, nav)
        if i < n then
            -- 180度回転
            if i % 2 == 1 then
                nav:move(TURN_RIGHT)
                nav:move(FORWARD)
                nav:move(TURN_RIGHT)
            else
                nav:move(TURN_LEFT)
                nav:move(FORWARD)
                nav:move(TURN_LEFT)
            end
        end
    end
end

-- 高さ ceil(k/3)*3 マス x 奥行きm x 幅nで掘りぬく
local function cube(m, n, k, nav)
    for i = 1, k, 3 do
        nav:with(function ()
            plane(m, n, nav)
        end)

        if k - i >= 3 then
            nav:move(UP)
            nav:move(UP)
            nav:move(UP)
        end
    end
end


local CHEST_STATION = Navigation.new(vector.new(0, 0, 0), WEST)
local FUEL_STATION = Navigation.new(vector.new(0, 0, 0), SOUTH)
local TARGET_FUEL_LEVEL = 2000

local hooks = {
    ["dig"] = {Create_free_slots_handler(CHEST_STATION)},
    ["move"] = {Create_refuel_handler(FUEL_STATION, CHEST_STATION, TARGET_FUEL_LEVEL)},
}

local command = args[1]
if command == "cube" then
    local m, n, k = tonumber(args[2]), tonumber(args[3]), tonumber(args[4])

    local nav = Navigation.new()
    nav:set_hooks(hooks)
    nav:with(function()
        nav:move(FORWARD)
        nav:with(function ()
            cube(m, n, k, nav)
        end)
    end)
elseif command == "plane" then
    local m, n = tonumber(args[2]), tonumber(args[3])
    
    local nav = Navigation.new()
    nav:set_hooks(hooks)
    nav:with(function ()
        nav:move(FORWARD)
        nav:with(function ()
            plane(m, n, nav)
        end)
    end)
elseif command == "line" then
    local nav = Navigation.new()
    nav:set_hooks(hooks)
    nav:with(function ()
        nav:move(FORWARD)
        line(tonumber(args[2]), nav)
    end)
-- elseif command == "refuel" then
--     local nav = Navigation.new()
--     nav:set_hooks(hooks)
--     nav:with(function ()
--         nav:goface(FUEL_STATION)
--         refuel(nav)
--     end)
end

-- http://www.computercraft.info/wiki/Turtle_(API)
-- dl https://mc.shosato.jp/branch.lua branch
